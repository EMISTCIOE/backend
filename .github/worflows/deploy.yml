name: Deploy TCIOE Django Backend
on:
  push:
    branches: [main]

jobs:
  test:
    name: Run Django Tests
    runs-on: ubuntu-latest

    env:
      CORS_ALLOW_ALL_ORIGINS: ${{ secrets.CORS_ALLOW_ALL_ORIGINS }}
      CORS_ALLOWED_ORIGINS: ${{ secrets.CORS_ALLOWED_ORIGINS }}
      DEBUG: ${{ secrets.DEBUG }}
      DJANGO_ALLOWED_HOSTS: ${{ secrets.DJANGO_ALLOWED_HOSTS }}
      SECRET_KEY: ${{ secrets.SECRET_KEY }}
      LOCAL: ${{ secrets.LOCAL }}
      WEBSITE_MEDIA_MAX_UPLOAD_SIZE: ${{ secrets.WEBSITE_MEDIA_MAX_UPLOAD_SIZE }}
      AUTH_LINK_EXP_TIME: ${{ secrets.AUTH_LINK_EXP_TIME }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Django dependencies
        run: |
          python -m venv venv
          source venv/bin/activate
          pip install -r requirements.txt

      - name: Run Django tests
        run: |
          source venv/bin/activate
          python manage.py test

  deploy:
    name: Deploy to Self-Hosted VPS
    runs-on: self-hosted
    needs: test
    if: success()

    env:
      CORS_ALLOW_ALL_ORIGINS: ${{ secrets.CORS_ALLOW_ALL_ORIGINS }}
      CORS_ALLOWED_ORIGINS: ${{ secrets.CORS_ALLOWED_ORIGINS }}
      DEBUG: ${{ secrets.DEBUG }}
      SECRET_KEY: ${{ secrets.SECRET_KEY }}
      LOCAL: ${{ secrets.LOCAL }}
      WEBSITE_MEDIA_MAX_UPLOAD_SIZE: ${{ secrets.WEBSITE_MEDIA_MAX_UPLOAD_SIZE }}
      AUTH_LINK_EXP_TIME: ${{ secrets.AUTH_LINK_EXP_TIME }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Run Unified VPS Deployer
        run: |
          cd /srv/deployer
          node deploy.js $GITHUB_REPOSITORY
